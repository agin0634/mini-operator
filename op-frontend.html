<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Op Server Frontend</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #343a40;
            --border-color: #ced4da;
            --border-radius: 4px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px; /* Wider container */
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        
        header h1 {
            text-align: center;
            font-size: 1.8em;
        }
        
        header .status-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 8px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background-color: var(--success-color); }
        .status-disconnected { background-color: var(--danger-color); }
        
        .main-content {
            display: grid;
            /* Adjust grid for three columns */
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: flex; /* Use flexbox for card layout */
            flex-direction: column; /* Stack elements vertically */
            height: 100%; /* Make cards fill grid cell height */
        }

        .card-fixed-height {
             min-height: 400px; /* Ensure minimum height for consistency */
        }
        
        .card h2 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            font-size: 1.2em;
        }

        .card-content {
            flex-grow: 1; /* Allow content to fill space */
            overflow-y: auto; /* Add scroll if content overflows */
        }
        
        /* Command form styles */
        .command-selector {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 10px; /* Use gap for spacing */
        }
        
        .command-btn {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .command-btn:hover { background-color: var(--medium-gray); }
        
        .command-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .parameters-form { margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-top: auto; /* Push button to bottom of card */
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover { background-color: #0056b3; }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover { background-color: #5a6268; }
        
        /* Log styles */
        .log-area, .status-area {
            max-height: 500px; /* Limit height */
            overflow-y: auto;
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: var(--border-radius);
            font-family: monospace;
            font-size: 13px;
            flex-grow: 1; /* Allow area to fill space */
        }

        .log-entry, .status-entry {
            padding: 8px; /* Slightly reduced padding */
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            white-space: pre-wrap;
            border-left: 3px solid transparent; /* Base border */
        }

        .log-request { background-color: #e0e0e0; border-left-color: var(--info-color); }
        .log-response-success { background-color: #d4edda; border-left-color: var(--success-color); }
        .log-response-error { background-color: #f8d7da; border-left-color: var(--danger-color); color: #721c24; }
        .log-info { background-color: #d1ecf1; border-left-color: var(--info-color); color: #0c5460; }

        .log-timestamp {
            font-size: 11px;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
        }

        /* System Status Styles */
        .status-section { margin-bottom: 15px; }
        .status-section h3 { font-size: 1em; margin-bottom: 8px; color: var(--primary-color); }
        .status-list { list-style: none; padding-left: 0; }
        .status-list li { background-color: #fff; border: 1px solid var(--border-color); padding: 8px; margin-bottom: 5px; border-radius: var(--border-radius); font-size: 0.9em; }
        .status-list li strong { color: var(--secondary-color); }
        
        /* Custom command styles */
        #custom-parameters { margin-top: 10px; }
        .custom-param-row { display: flex; margin-bottom: 10px; gap: 10px; }
        .custom-param-row input { flex-grow: 1; }
        .remove-param { background-color: var(--danger-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; padding: 0 10px; font-size: 1.2em; flex-shrink: 0; }
        .add-param { background-color: var(--success-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; padding: 5px 10px; margin-bottom: 15px; }
        
        /* Toast notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { padding: 15px 20px; margin-bottom: 10px; border-radius: var(--border-radius); box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16); color: white; display: flex; align-items: center; justify-content: space-between; min-width: 300px; animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards; }
        .toast-success { background-color: var(--success-color); }
        .toast-error { background-color: var(--danger-color); }
        .toast-info { background-color: var(--info-color); }
        .close-toast { background: none; border: none; color: white; font-size: 16px; cursor: pointer; margin-left: 15px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr; /* Stack columns on smaller screens */
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Op Server Frontend</h1>
            <div class="status-indicator">
                <div class="status-dot status-disconnected" id="status-dot"></div>
                <span id="connection-status">Disconnected</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="main-content">
            <!-- Command Form Card -->
            <div class="card card-fixed-height">
                <h2>Send Command</h2>
                <div class="card-content">
                    <div class="command-selector">
                        <button class="command-btn active" data-command="PING">Ping</button>
                        <button class="command-btn" data-command="CALCULATE_SUM">Calculate Sum</button>
                        <button class="command-btn" data-command="HEARTBEAT">Heartbeat</button>
                        <button class="command-btn" data-command="GET_SYSTEM_STATUS">Get System Status</button>
                        <button class="command-btn" data-command="CREATE_ROOM">Create Room</button>
                        <button class="command-btn" data-command="PAIR_USER">Pair User</button>
                        <button class="command-btn" data-command="custom">Custom</button>
                    </div>
                    
                    <div id="parameters-container">
                        <!-- Ping Form -->
                        <div class="parameters-form" id="PING-form">
                            <p>Sends a simple PING command to the server.</p>
                        </div>
                        
                        <!-- Calculate Sum Form -->
                        <div class="parameters-form" id="CALCULATE_SUM-form" style="display: none;">
                            <div class="form-group">
                                <label for="sum-num1">Number 1</label>
                                <input type="number" id="sum-num1" class="form-control" value="10">
                            </div>
                            <div class="form-group">
                                <label for="sum-num2">Number 2</label>
                                <input type="number" id="sum-num2" class="form-control" value="25">
                            </div>
                        </div>

                        <!-- Heartbeat Form -->
                        <div class="parameters-form" id="HEARTBEAT-form" style="display: none;">
                            <div class="form-group">
                                <label for="heartbeat-vrId">VrID</label>
                                <input type="text" id="heartbeat-vrId" class="form-control" value="VR001">
                            </div>
                             <div class="form-group">
                                <label for="heartbeat-timestamp">Timestamp (Unix Epoch seconds)</label>
                                <input type="number" step="any" id="heartbeat-timestamp" class="form-control" placeholder="Leave blank for current time">
                                <small>Leave blank to send current server time.</small>
                            </div>
                        </div>

                        <!-- Get System Status Form -->
                        <div class="parameters-form" id="GET_SYSTEM_STATUS-form" style="display: none;">
                            <p>Retrieves the current status of agents and rooms from the server.</p>
                            <button type="button" id="refresh-status-btn" class="btn btn-secondary" style="margin-top: 10px;">Refresh Status Now</button>
                        </div>

                        <!-- Create Room Form -->
                        <div class="parameters-form" id="CREATE_ROOM-form" style="display: none;">
                             <div class="form-group">
                              <label for="create-room-vrids">Assigned VR IDs (comma-separated)</label>
                                <input type="text" id="create-room-vrids" class="form-control" placeholder="e.g., VR001,VR002,VR003">
                            </div>
                             <div class="form-group">
                                <label for="create-room-language">Language</label>
                                <input type="text" id="create-room-language" class="form-control" value="CHT" placeholder="e.g., CHT, ENG">
                            </div>
                        </div>

                        <!-- Pair User Form -->
                        <div class="parameters-form" id="PAIR_USER-form" style="display: none;">
                             <div class="form-group">
                                <label for="pair-user-roomid">Room ID</label>
                                <input type="text" id="pair-user-roomid" class="form-control" placeholder="e.g., 8001">
                            </div>
                             <div class="form-group">
                                <label for="pair-user-vrid">VR ID</label>
                                <input type="text" id="pair-user-vrid" class="form-control" placeholder="e.g., VR001">
                            </div>
                             <div class="form-group">
                                <label for="pair-user-token">User Token</label>
                                <input type="text" id="pair-user-token" class="form-control" placeholder="Enter user token">
                            </div>
                        </div>
                        
                        <!-- Custom Command Form -->
                        <div class="parameters-form" id="custom-form" style="display: none;">
                            <div class="form-group">
                                <label for="custom-command">Command Name</label>
                                <input type="text" id="custom-command" class="form-control" placeholder="Enter command name (e.g., MY_COMMAND)">
                            </div>
                            <label>Parameters (Key-Value Pairs)</label>
                            <button type="button" class="add-param" id="add-param-btn">+ Add Parameter</button>
                            <div id="custom-parameters">
                                <!-- Parameter rows added dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" id="send-command" class="btn btn-primary">Send Command</button>
            </div>
            
            <!-- System Status Card -->
            <div class="card card-fixed-height">
                <h2>System Status</h2>
                 <div class="card-content status-area" id="system-status-area">
                    <div class="status-entry">Waiting for status update...</div>
                    <!-- Status will be populated here -->
                </div>
                 <button type="button" id="manual-refresh-status-btn" class="btn btn-secondary">Refresh Status</button>
            </div>

            <!-- Server Log Card -->
            <div class="card card-fixed-height">
                <h2>Server Log</h2>
                <div class="card-content log-area" id="log-area">
                    <div class="log-entry log-info">Waiting for connection...</div>
                </div>
                 <button type="button" id="clear-log-btn" class="btn btn-secondary">Clear Log</button>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toast-container"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const SERVER_URL = `ws://${window.location.hostname || 'localhost'}:8766`; // Use hostname or default to localhost
            
            // DOM Elements
            const statusDot = document.getElementById('status-dot');
            const connectionStatus = document.getElementById('connection-status');
            const commandButtons = document.querySelectorAll('.command-btn');
            const sendCommandBtn = document.getElementById('send-command');
            const logArea = document.getElementById('log-area');
            const systemStatusArea = document.getElementById('system-status-area');
            const addParamBtn = document.getElementById('add-param-btn');
            const customParametersDiv = document.getElementById('custom-parameters');
            const toastContainer = document.getElementById('toast-container');
            const refreshStatusBtn = document.getElementById('refresh-status-btn');
            const manualRefreshStatusBtn = document.getElementById('manual-refresh-status-btn');
            const clearLogBtn = document.getElementById('clear-log-btn');
            
            // State
            let currentCommand = 'PING'; // Default command
            let websocket = null;
            let isConnected = false;
            let reconnectInterval = null;
            let statusRefreshInterval = null; // Timer for auto-refresh
            
            // Connect to WebSocket server
            function connectWebSocket() {
                if (reconnectInterval) clearInterval(reconnectInterval); // Clear existing interval if any
                logToUI("Attempting to connect to " + SERVER_URL + "...", 'info');
                
                // Close existing socket if necessary
                if (websocket && websocket.readyState !== WebSocket.CLOSED) {
                    websocket.close();
                }

                websocket = new WebSocket(SERVER_URL);
                
                websocket.onopen = function(event) {
                    isConnected = true;
                    updateConnectionStatus(true);
                    showToast('Connected to Op Server', 'success');
                    logToUI("Connection established.", 'success');
                    if (reconnectInterval) clearInterval(reconnectInterval); // Stop retrying on successful connection
                    
                    // Request initial status immediately
                    sendCommandInternal('GET_SYSTEM_STATUS', {}); 
                    
                    // Start auto-refresh timer
                    if (statusRefreshInterval) clearInterval(statusRefreshInterval); // Clear old timer if exists
                    statusRefreshInterval = setInterval(requestSystemStatus, 5000); // Refresh every 5 seconds
                    logToUI("Started automatic status refresh (every 3s).", 'info');
                };
                
                websocket.onclose = function(event) {
                    // Stop auto-refresh timer
                    if (statusRefreshInterval) {
                        clearInterval(statusRefreshInterval);
                        statusRefreshInterval = null;
                        logToUI("Stopped automatic status refresh.", 'info');
                    }
                    isConnected = false;
                    updateConnectionStatus(false);
                    const reason = event.reason || `code ${event.code}`;
                    const message = `Disconnected (${reason}). Retrying...`;
                    // Only show toast on initial disconnect, not every retry
                    if (!reconnectInterval) {
                         showToast(message, 'error');
                    }
                    logToUI(message, 'error');
                    
                    // Simple exponential backoff (or just fixed interval)
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(connectWebSocket, 5000); // Retry every 5 seconds
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    // Don't show toast here, onclose will handle it
                    logToUI('WebSocket connection error.', 'error');
                    // Ensure connection status is updated
                    isConnected = false;
                    updateConnectionStatus(false);
                    // Stop auto-refresh timer
                    if (statusRefreshInterval) {
                        clearInterval(statusRefreshInterval);
                        statusRefreshInterval = null;
                        logToUI("Stopped automatic status refresh due to error.", 'info');
                    }
                    // onclose will likely be called next, triggering reconnect logic
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const response = JSON.parse(event.data);
                        handleServerMessage(response);
                    } catch (e) {
                        console.error("Failed to parse server message:", event.data, e);
                        logToUI(`Received invalid JSON: ${event.data}`, 'error');
                    }
                };
            }
            
            // Update connection status indicator
            function updateConnectionStatus(connected) {
                if (connected) {
                    statusDot.classList.remove('status-disconnected');
                    statusDot.classList.add('status-connected');
                    connectionStatus.textContent = 'Connected';
                } else {
                    statusDot.classList.remove('status-connected');
                    statusDot.classList.add('status-disconnected');
                    connectionStatus.textContent = 'Disconnected';
                }
            }

            // Log messages to the UI log area
            function logToUI(message, type = 'info', data = null) {
                const entry = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                let content = `<span class="log-timestamp">[${timestamp}]</span> ${message}`;
                
                if (data && Object.keys(data).length > 0) { // Only show data if it's not empty
                    try {
                        content += `\n${JSON.stringify(data, null, 2)}`;
                    } catch (e) {
                        content += `\n[Could not stringify data: ${e}]`;
                    }
                }

                entry.innerHTML = content;
                entry.className = 'log-entry';

                switch (type) {
                    case 'request': entry.classList.add('log-request'); break;
                    case 'success': entry.classList.add('log-response-success'); break;
                    case 'error': entry.classList.add('log-response-error'); break;
                    default: entry.classList.add('log-info'); break; // Use info for general messages
                }

                // Remove placeholder if it exists
                const placeholder = logArea.querySelector('.log-info:only-child');
                if (placeholder && placeholder.textContent.includes("Waiting")) {
                    placeholder.remove();
                }

                logArea.appendChild(entry);
                logArea.scrollTop = logArea.scrollHeight; // Scroll to bottom
            }

            // Update the System Status display area
            function updateSystemStatusUI(agents = [], rooms = []) {
                 systemStatusArea.innerHTML = ''; // Clear previous status

                 if (!agents.length && !rooms.length) {
                     systemStatusArea.innerHTML = '<div class="status-entry log-info">No agents or rooms reported.</div>';
                     return;
                 }

                 // Agents Section
                 const agentsSection = document.createElement('div');
                 agentsSection.className = 'status-section';
                 agentsSection.innerHTML = '<h3>Agents</h3>';
                 const agentList = document.createElement('ul');
                 agentList.className = 'status-list';
                 if (agents.length > 0) {
                     agents.forEach(agent => {
                         const li = document.createElement('li');
                         li.innerHTML = `<strong>ID:</strong> ${agent.vrId || 'N/A'} | <strong>Status:</strong> ${agent.connectionStatus || 'N/A'} | <strong>Content:</strong> ${agent.currentContent || 'N/A'} | <strong>Room:</strong> ${agent.assignedRoom || 'None'}`;
                         agentList.appendChild(li);
                     });
                 } else {
                     agentList.innerHTML = '<li>No agents connected.</li>';
                 }
                 agentsSection.appendChild(agentList);
                 systemStatusArea.appendChild(agentsSection);

                 // Rooms Section
                 const roomsSection = document.createElement('div');
                 roomsSection.className = 'status-section';
                 roomsSection.innerHTML = '<h3>Rooms</h3>';
                 const roomList = document.createElement('ul');
                 roomList.className = 'status-list';
                  if (rooms.length > 0) {
                     rooms.forEach(room => {
                         const li = document.createElement('li');
                         const vrIds = Array.isArray(room.assignedVRs) ? room.assignedVRs.join(', ') : 'None';
                         li.innerHTML = `<strong>ID:</strong> ${room.roomId || 'N/A'} | <strong>Status:</strong> ${room.status || 'N/A'} | <strong>Content:</strong> ${room.contentName || 'N/A'} (${room.contentId || 'N/A'}) | <strong>VRs:</strong> ${vrIds}`;
                         roomList.appendChild(li);
                     });
                 } else {
                     roomList.innerHTML = '<li>No active rooms.</li>';
                 }
                 roomsSection.appendChild(roomList);
                 systemStatusArea.appendChild(roomsSection);

                 systemStatusArea.scrollTop = 0; // Scroll to top after update
            }
            
            // Show toast notification
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `<span>${message}</span><button class="close-toast">&times;</button>`;
                toastContainer.appendChild(toast);
                
                const removeToast = () => {
                    toast.style.animation = 'fadeOut 0.5s forwards';
                    setTimeout(() => toast.remove(), 500);
                };

                const timer = setTimeout(removeToast, 5000);
                toast.querySelector('.close-toast').addEventListener('click', () => {
                    clearTimeout(timer);
                    removeToast();
                });
            }
            
            // Handle messages from the server
            function handleServerMessage(response) {
                const status = response.status || 'info'; // Default to info if status missing
                const message = response.message || 'Received raw message'; // Generic message
                // Log the entire response object
                logToUI(`Received:`, status, response); 

                // Special handling for GET_SYSTEM_STATUS response based on structure
                if (response.status === 'success' && response.agents !== undefined && response.rooms !== undefined) {
                     updateSystemStatusUI(response.agents, response.rooms);
                } 
                
                // Show toast only for explicit errors
                if (response.status === 'error') {
                    showToast(`Error: ${response.message || 'Unknown server error'}`, 'error');
                }
            }

            // Internal function to send command without logging request again
            function sendCommandInternal(commandName, params) {
                 if (!isConnected) {
                    showToast('Not connected to server', 'error');
                    logToUI('Cannot send command: Not connected.', 'error');
                    return false;
                }
                 const messageToSend = {
                    command: commandName,
                    ...params // Spread parameters into the root object
                };
                const jsonMessage = JSON.stringify(messageToSend);
                websocket.send(jsonMessage);
                return true;
            }
            
            // Gather parameters and send command (called by button click)
            function sendSelectedCommand() {
                let commandName = currentCommand;
                let params = {}; 
                
                try {
                    // Get parameters based on current command
                    if (currentCommand === 'CALCULATE_SUM') {
                        params.num1 = parseFloat(document.getElementById('sum-num1').value) || 0;
                        params.num2 = parseFloat(document.getElementById('sum-num2').value) || 0;
                    } else if (currentCommand === 'HEARTBEAT') {
                        params.vrId = document.getElementById('heartbeat-vrId').value || 'UnknownVrID';
                        const tsInput = document.getElementById('heartbeat-timestamp').value;
                        // Only include timestamp if provided, otherwise server uses its own time
                        if (tsInput) {
                             params.timestamp = parseFloat(tsInput);
                             if (isNaN(params.timestamp)) {
                                 showToast('Invalid timestamp provided for HEARTBEAT.', 'warning');
                                 return; // Don't send if timestamp is invalid
                             }
                        } else {
                             // Send current time if field is empty
                             params.timestamp = Date.now() / 1000;
                             // Optionally update the field
                             // document.getElementById('heartbeat-timestamp').value = params.timestamp;
                        }
                    } else if (currentCommand === 'CREATE_ROOM') {
                        const vrIdsString = document.getElementById('create-room-vrids').value.trim();
                        params.vrIds = vrIdsString ? vrIdsString.split(',').map(id => id.trim()).filter(id => id) : []; // Split, trim, remove empty
                        params.language = document.getElementById('create-room-language').value.trim() || 'CHT'; // Add language, default CHT
                    } else if (currentCommand === 'PAIR_USER') {
                        params.roomId = document.getElementById('pair-user-roomid').value.trim();
                        params.vrId = document.getElementById('pair-user-vrid').value.trim();
                        params.userToken = document.getElementById('pair-user-token').value.trim();
                        if (!params.roomId || !params.vrId || !params.userToken) {
                            showToast('Room ID, VR ID, and User Token are required for PAIR_USER.', 'warning');
                            return;
                        }
                    } else if (currentCommand === 'GET_SYSTEM_STATUS') {
                        // No parameters needed
                    } else if (currentCommand === 'PING') {
                         // No parameters needed
                    } else if (currentCommand === 'custom') {
                        commandName = document.getElementById('custom-command').value.trim().toUpperCase();
                        if (!commandName) {
                            showToast('Please enter a command name for the custom command', 'warning');
                            return;
                        }
                        // Get custom parameters
                        const paramRows = document.querySelectorAll('#custom-parameters .custom-param-row');
                        paramRows.forEach(row => {
                            const nameInput = row.querySelector('.param-name');
                            const valueInput = row.querySelector('.param-value');
                            const name = nameInput.value.trim();
                            const value = valueInput.value.trim();

                            if (name) {
                                // Basic type detection
                                if (value.toLowerCase() === 'true') params[name] = true;
                                else if (value.toLowerCase() === 'false') params[name] = false;
                                else if (!isNaN(Number(value)) && value !== '') params[name] = Number(value);
                                else {
                                     // Try parsing as JSON array/object
                                     try {
                                         const parsedJson = JSON.parse(value);
                                         // Check if it's an array or object (not just a stringified primitive)
                                         if (typeof parsedJson === 'object' && parsedJson !== null) {
                                             params[name] = parsedJson;
                                         } else {
                                             params[name] = value; // Treat as string if not object/array
                                         }
                                     } catch (e) {
                                         params[name] = value; // Default to string if JSON parse fails
                                     }
                                }
                            }
                        });
                    }

                    // Log the request before sending
                    logToUI(`Sending command: ${commandName}`, 'request', params);

                    // Send the command
                    if (sendCommandInternal(commandName, params)) {
                         showToast(`Command "${commandName}" sent`, 'info');
                    }

                } catch (error) {
                    console.error("Error preparing command:", error);
                    showToast(`Error preparing command: ${error.message}`, 'error');
                    logToUI(`Error preparing command ${commandName}: ${error}`, 'error');
                }
            }
            
            // Switch between command types in the UI
            function switchCommand(command) {
                currentCommand = command;
                document.querySelectorAll('.parameters-form').forEach(form => form.style.display = 'none');
                const formToShow = document.getElementById(`${command}-form`);
                if (formToShow) formToShow.style.display = 'block';
                commandButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.command === command);
                });
                 // Hide send button for GET_SYSTEM_STATUS as it has its own refresh button
                sendCommandBtn.style.display = (command === 'GET_SYSTEM_STATUS') ? 'none' : 'block';
            }

            // Add parameter row to custom command form
            function addParameterRow() {
                const row = document.createElement('div');
                row.className = 'custom-param-row';
                row.innerHTML = `
                    <input type="text" placeholder="Param name" class="param-name form-control">
                    <input type="text" placeholder="Value (string, number, bool, JSON)" class="param-value form-control">
                    <button type="button" class="remove-param btn">&times;</button>
                `;
                customParametersDiv.appendChild(row);
                row.querySelector('.remove-param').addEventListener('click', () => row.remove());
            }

            function clearLog() {
                logArea.innerHTML = '<div class="log-entry log-info">Log cleared.</div>';
            }

            function requestSystemStatus() {
                 logToUI('Requesting system status update...', 'request');
                 if (sendCommandInternal('GET_SYSTEM_STATUS', {})) {
                     showToast('Requested system status', 'info');
                 }
            }
            
            // --- Event Listeners ---
            commandButtons.forEach(btn => btn.addEventListener('click', function() { switchCommand(this.dataset.command); }));
            sendCommandBtn.addEventListener('click', sendSelectedCommand);
            addParamBtn.addEventListener('click', addParameterRow);
            clearLogBtn.addEventListener('click', clearLog);
            refreshStatusBtn.addEventListener('click', requestSystemStatus); // Button within the GET_SYSTEM_STATUS form
            manualRefreshStatusBtn.addEventListener('click', requestSystemStatus); // Button below the status display

            // Initialize remove parameter buttons for any potentially pre-existing rows
            document.querySelectorAll('.remove-param').forEach(btn => btn.addEventListener('click', function() { this.closest('.custom-param-row').remove(); }));
            
            // --- Initial Setup ---
            switchCommand(currentCommand); // Set initial form visibility
            connectWebSocket(); // Start connection attempt
        });
    </script>
</body>
</html>
